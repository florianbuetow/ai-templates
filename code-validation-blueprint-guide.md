# Code Validation Blueprint for Python Projects

This document contains the complete code validation infrastructure from a production Python project. Copy the configurations you need into your project.

**Contents:** Makefile targets, tool configurations, dependencies, and custom static analysis rules.

---

## Directory Structure

```text
project/
├── Makefile                # Validation targets (see below)
├── pyproject.toml          # Tool configurations (ruff, mypy, pytest, bandit, deptry, codespell)
├── pyrightconfig.json      # Pyright LSP configuration
├── .pre-commit-config.yaml # Git hooks
├── config/
│   ├── semgrep/           # Custom static analysis rules
│   │   ├── no-default-values.yml
│   │   ├── no-sneaky-fallbacks.yml
│   │   ├── no_type_suppression.yml
│   │   ├── no-noqa.yml
│   │   └── python-constants.yml
│   └── codespell/
│       └── ignore.txt      # Domain-specific spell-check ignore list
└── reports/               # Generated by CI (add to .gitignore)
    ├── coverage/
    ├── security/
    ├── pyright/
    └── deptry/
```

---

## Makefile Targets

Add these to your Makefile:

```makefile
# Configuration
.PHONY: code-style code-format code-typecheck code-lspchecks code-security code-deptry code-stats code-spell code-audit code-semgrep
.PHONY: test test-coverage ci ci-quiet

# Color codes for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m  # No Color

##@ Prerequisites

init: ## Initialize local development environment
	@echo "$(BLUE)=== Initializing Development Environment ===$(NC)"
	@mkdir -p reports/coverage
	@mkdir -p reports/security
	@mkdir -p reports/pyright
	@mkdir -p reports/deptry
	@echo "Installing Python dependencies..."
	@uv sync --all-extras
	@echo "$(GREEN)✓ Development environment ready$(NC)"
	@echo ""

##@ Code Quality & Validation

code-style: ## Check code style and formatting (read-only)
	@echo "$(BLUE)=== Checking Code Style ===$(NC)"
	@uv run ruff check .
	@echo ""
	@uv run ruff format --check .
	@echo ""
	@echo "$(GREEN)✓ Style checks passed$(NC)"
	@echo ""

code-format: ## Auto-fix code style and formatting
	@echo "$(BLUE)=== Formatting Code ===$(NC)"
	@uv run ruff check . --fix
	@echo ""
	@uv run ruff format .
	@echo ""
	@echo "$(GREEN)✓ Code formatted$(NC)"
	@echo ""

code-typecheck: ## Run static type checking with mypy
	@echo "$(BLUE)=== Running Type Checks ===$(NC)"
	@uv run mypy src/
	@echo ""
	@echo "$(GREEN)✓ Type checks passed$(NC)"
	@echo ""

code-lspchecks: ## Run strict type checking with Pyright (LSP-based)
	@echo "$(BLUE)=== Running Pyright Type Checks ===$(NC)"
	@mkdir -p reports/pyright
	@uv run pyright --project pyrightconfig.json > reports/pyright/pyright.txt 2>&1 || true
	@uv run pyright --project pyrightconfig.json
	@echo ""
	@echo "$(GREEN)✓ Pyright checks passed$(NC)"
	@echo "  Report: reports/pyright/pyright.txt"
	@echo ""

code-security: ## Run security checks with bandit
	@echo "$(BLUE)=== Running Security Checks ===$(NC)"
	@mkdir -p reports/security
	@uv run bandit -c pyproject.toml -r src -f txt -o reports/security/bandit.txt || true
	@uv run bandit -c pyproject.toml -r src
	@echo ""
	@echo "$(GREEN)✓ Security checks passed$(NC)"
	@echo ""

code-deptry: ## Check dependency hygiene with deptry
	@echo "$(BLUE)=== Checking Dependencies ===$(NC)"
	@mkdir -p reports/deptry
	@uv run deptry src
	@echo ""
	@echo "$(GREEN)✓ Dependency checks passed$(NC)"
	@echo ""

PYGOUNT_DIRS := src/ tests/ proto/ scripts/ infra/ docs/ *.md *.toml
PYGOUNT_OPTS := --suffix=py,js,html,htm,sh,yaml,yml,proto,md,txt,css,toml,log --format=summary

code-stats: ## Generate code statistics with pygount
	@echo "$(BLUE)=== Code Statistics ===$(NC)"
	@mkdir -p reports
	@uv run pygount $(PYGOUNT_DIRS) $(PYGOUNT_OPTS)
	@echo ""
	@uv run pygount $(PYGOUNT_DIRS) $(PYGOUNT_OPTS) > reports/code-stats.txt
	@echo "$(GREEN)✓ Report saved to reports/code-stats.txt$(NC)"
	@echo ""

code-spell: ## Check spelling in code and documentation
	@echo "$(BLUE)=== Checking Spelling ===$(NC)"
	@uv run codespell src tests docs scripts infra proto *.md *.toml
	@echo ""
	@echo "$(GREEN)✓ Spelling checks passed$(NC)"
	@echo ""

code-audit: ## Scan dependencies for known vulnerabilities
	@echo "$(BLUE)=== Scanning Dependencies for Vulnerabilities ===$(NC)"
	@uv run pip-audit
	@echo ""
	@echo "$(GREEN)✓ No known vulnerabilities found$(NC)"
	@echo ""

code-semgrep: ## Run Semgrep static analysis (no default values)
	@echo "$(BLUE)=== Running Semgrep Static Analysis ===$(NC)"
	@uv run semgrep --config config/semgrep/ --error src
	@echo ""
	@echo "$(GREEN)✓ Semgrep checks passed$(NC)"
	@echo ""

##@ Testing

test: ## Run unit tests only (fast, no cluster required)
	@echo "$(BLUE)=== Running Unit Tests ===$(NC)"
	@uv run pytest tests/ -v
	@echo ""

test-coverage: init ## Run unit tests with coverage report and threshold check
	@echo "$(BLUE)=== Running Unit Tests with Coverage ===$(NC)"
	@uv run pytest tests/ -v \
		--cov=src \
		--cov-report=html:reports/coverage/html \
		--cov-report=term \
		--cov-report=xml:reports/coverage/coverage.xml \
		--cov-fail-under=80
	@echo ""
	@echo "$(GREEN)✓ Coverage threshold met$(NC)"
	@echo "  HTML: reports/coverage/html/index.html"
	@echo ""

##@ CI/CD

ci: ## Run ALL validation checks (verbose)
	@echo ""
	@echo "$(BLUE)=== Running CI Checks ===$(NC)"
	@echo ""
	@$(MAKE) init
	@$(MAKE) code-format
	@$(MAKE) code-style
	@$(MAKE) code-typecheck
	@$(MAKE) code-security
	@$(MAKE) code-deptry
	@$(MAKE) code-spell
	@$(MAKE) code-semgrep
	@$(MAKE) code-audit
	@$(MAKE) test
	@$(MAKE) code-lspchecks
	@echo ""
	@echo "$(GREEN)✓ All CI checks passed$(NC)"
	@echo ""

ci-quiet: ## Run ALL validation checks silently (only show output on errors)
	@echo "$(BLUE)=== Running CI Checks (Quiet Mode) ===$(NC)"
	@TMPFILE=$$(mktemp); \
	$(MAKE) init > $$TMPFILE 2>&1 || { echo "$(RED)✗ Init failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Init passed$(NC)"; \
	$(MAKE) code-format > $$TMPFILE 2>&1 || { echo "$(RED)✗ Code-format failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Code-format passed$(NC)"; \
	$(MAKE) code-style > $$TMPFILE 2>&1 || { echo "$(RED)✗ Code-style failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Code-style passed$(NC)"; \
	$(MAKE) code-typecheck > $$TMPFILE 2>&1 || { echo "$(RED)✗ Code-typecheck failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Code-typecheck passed$(NC)"; \
	$(MAKE) code-security > $$TMPFILE 2>&1 || { echo "$(RED)✗ Code-security failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Code-security passed$(NC)"; \
	$(MAKE) code-deptry > $$TMPFILE 2>&1 || { echo "$(RED)✗ Code-deptry failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Code-deptry passed$(NC)"; \
	$(MAKE) code-spell > $$TMPFILE 2>&1 || { echo "$(RED)✗ Code-spell failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Code-spell passed$(NC)"; \
	$(MAKE) code-semgrep > $$TMPFILE 2>&1 || { echo "$(RED)✗ Code-semgrep failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Code-semgrep passed$(NC)"; \
	$(MAKE) code-audit > $$TMPFILE 2>&1 || { echo "$(RED)✗ Code-audit failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Code-audit passed$(NC)"; \
	$(MAKE) test > $$TMPFILE 2>&1 || { echo "$(RED)✗ Test failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Test passed$(NC)"; \
	$(MAKE) code-lspchecks > $$TMPFILE 2>&1 || { echo "$(RED)✗ Code-lspchecks failed$(NC)"; cat $$TMPFILE; rm $$TMPFILE; exit 1; }; \
	echo "$(GREEN)✓ Code-lspchecks passed$(NC)"; \
	rm $$TMPFILE; \
	echo ""; \
	echo "$(GREEN)✓ All CI checks passed$(NC)"; \
	echo ""
	@echo ""
```

---

## Dependencies

Add these to your `pyproject.toml`:

```toml
[project.optional-dependencies]
dev = [
    # Testing
    "pytest>=7.4.0",
    "pytest-asyncio>=0.21.0",
    "pytest-cov>=4.1.0",
    "pytest-grpc>=0.8.0",
    "pytest-randomly>=3.15.0",
    "pytest-timeout>=2.2.0",

    # Linting & Formatting
    "ruff>=0.1.0",

    # Type Checking
    "mypy>=1.7.0",
    "mypy-protobuf>=3.5.0",
    "pyright>=1.1.0",

    # Type Stubs
    "types-protobuf>=5.27.0",
    "types-PyYAML>=6.0.0",
    "types-redis>=4.6.0",

    # Security & Quality
    "bandit[toml]>=1.7.8",
    "deptry>=0.20.0",
    "pygount>=1.6.4",
    "codespell>=2.3.0",
    "pip-audit>=2.7.0",
    "semgrep>=1.144.0",

    # Git Hooks
    "pre-commit>=3.6.0",
]
```

---

## Configuration Files

### pyproject.toml

Configuration for all validation tools:

```toml
[tool.ruff]
line-length = 140
indent-width = 4
target-version = "py311"
# Exclude generated code, notes, data, and tools from linting
exclude = ["src/proto_gen/*", "notes/*", "data/*", "tools/*"]

[tool.ruff.lint]
# Core errors & warnings, Google-style docs, types, bugbear, quotes, imports, naming
# Plus: complexity, modern syntax, performance, simplifications, tidy imports
select = [
  "E", "F",   # pycodestyle errors, pyflakes
  "D",        # pydocstyle (Google-style)
  "ANN",      # flake8-annotations
  "B",        # flake8-bugbear
  "Q",        # flake8-quotes
  "I",        # isort
  "N",        # pep8-naming
  "C90",      # mccabe complexity
  "UP",       # pyupgrade (modern Python 3.11+ syntax)
  "PERF",     # perflint (performance anti-patterns)
  "SIM",      # flake8-simplify
  "TID",      # flake8-tidy-imports
]
ignore = [
  "D107",    # don't require __init__ docstring (class docstring is fine)
  "N802",    # allow non-lowercase function names (needed for gRPC method names)
]

[tool.ruff.lint.mccabe]
# Flag functions with complexity > 10 (default is 10, explicit for clarity)
max-complexity = 10

[tool.ruff.lint.flake8-tidy-imports]
# Ban relative imports for cleaner, more explicit code
ban-relative-imports = "all"

[tool.ruff.lint.pydocstyle]
convention = "google"

[tool.ruff.lint.per-file-ignores]
"tests/**/*.py" = ["D", "ANN"]  # optional, if you find tests too noisy

[tool.ruff.format]
quote-style = "double"
indent-style = "space"

[tool.pytest.ini_options]
asyncio_mode = "auto"
pythonpath = ["."]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
# pytest-timeout: prevent tests from hanging indefinitely (especially async/gRPC)
timeout = 30
timeout_method = "thread"
# pytest-randomly: randomize test order to catch hidden dependencies
# Seed is logged; use --randomly-seed=<value> to reproduce

[tool.mypy]
python_version = "3.11"
plugins = ["pydantic.mypy"]
strict = true
warn_unused_configs = true

# Limit what mypy considers part of the project
files = ["src", "tests"]

# CI ergonomics
show_error_codes = true
pretty = true

# Exclude virtual environment (files already excludes it, but belt-and-suspenders)
exclude = [".venv/"]

# Generated protobuf / gRPC code – ignore errors completely
[[tool.mypy.overrides]]
module = ["src.proto_gen.*"]
ignore_errors = true

# Tests – still type checked, but not fully strict
[[tool.mypy.overrides]]
module = ["tests.*"]
disallow_untyped_defs = false
check_untyped_defs = false

[tool.pydantic-mypy]
init_forbid_extra = true
init_typed = true
warn_required_dynamic_aliases = true
warn_untyped_fields = true

[tool.coverage.run]
source = ["src"]
omit = [
    "*/tests/*",
    "*/test_*.py",
    "*/__init__.py",
    "*/proto_gen/*",
]
branch = true

[tool.coverage.report]
precision = 2
show_missing = true
skip_covered = false
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "raise AssertionError",
    "raise NotImplementedError",
    "if __name__ == .__main__.:",
    "if TYPE_CHECKING:",
    "@abstractmethod",
    "@abc.abstractmethod",
]

[tool.coverage.html]
directory = "reports/coverage/html"

[tool.coverage.xml]
output = "reports/coverage/coverage.xml"

[tool.bandit]
targets = ["src"]
exclude = [
    "tests",
    "*/proto_gen/*",
    ".venv",
    "venv",
]

# Reasonable default for CI:
severity = "MEDIUM"
confidence = "MEDIUM"

[tool.deptry]
# Source scanning - only check src/ directory
# Default excludes: .venv, .direnv, .git, tests, setup.py
extend_exclude = [
    "build",
    "dist",
    "docs",
    "scripts",
    "infra",
    "proto",
    "data",
    "reports",
    "notes",              # Reference notes and documentation
    "src/proto_gen",      # Generated protobuf/gRPC code
    "tools",              # Development tools with their own dependencies
]

# Ignore Jupyter notebooks (not part of production code)
ignore_notebooks = true

# First-party modules - tell deptry what belongs to this project
known_first_party = [
    "src",
]

# PEP 621 dev dependency groups - these are NOT runtime dependencies
pep621_dev_dependency_groups = [
    "dev",
]

# Keep all rules enabled (DEP001-DEP005)
# Use per_rule_ignores for specific, justified exceptions only
ignore = []

# CI/Reporting integration
json_output = "reports/deptry/deptry.json"

[tool.deptry.per_rule_ignores]
# Add specific package ignores with comments explaining why
# Example:
# DEP002 = [
#     "grpcio-tools",        # Build-time only: used by make generate-grpc
# ]

[tool.codespell]
# Paths to check
check-filenames = true
check-hidden = false

# Directories to skip
skip = ".git,.venv,venv,build,dist,reports,src/proto_gen,notes,*.lock,uv.lock"

# Use external ignore file for maintainability
ignore-words = "config/codespell/ignore.txt"
```

---

### pyrightconfig.json

Pyright LSP-based type checker configuration:

```json
{
  "pythonVersion": "3.11",
  "pythonPlatform": "Darwin",
  "venvPath": ".",
  "venv": ".venv",
  "stubPath": "stubs",
  "include": [
    "src",
    "tests"
  ],
  "exclude": [
    "**/__pycache__",
    "**/.pytest_cache",
    "**/node_modules",
    "**/.venv",
    "src/proto_gen"
  ],
  "typeCheckingMode": "strict",
  "useLibraryCodeForTypes": true,
  "reportMissingImports": true,
  "reportMissingTypeStubs": true
}
```

---

### .pre-commit-config.yaml

Git pre-commit hooks that run CI checks:

```yaml
# Pre-commit hooks configuration
# Install: uv run pre-commit install
# Run manually: uv run pre-commit run --all-files
# Skip temporarily: git commit --no-verify

repos:
  - repo: local
    hooks:
      - id: run-make-ci-quiet
        name: Run make ci-quiet
        entry: make ci-quiet
        language: system
        pass_filenames: false
        always_run: true
        verbose: true
```

---

### config/semgrep/no-default-values.yml

Bans default parameter values to enforce explicit configuration:

```yaml
rules:
  - id: xrag.no-default-parameter-values
    languages: [python]
    message: >
      Default parameter values hide configuration errors. Use explicit required parameters
      and validate at the call site instead or raise an error when a parameter unexpectedly is missing or not set.
    severity: ERROR
    pattern-either:
      - pattern: |
          def $FUNC(..., $PARAM=$DEFAULT, ...):
              ...
      - pattern: |
          async def $FUNC(..., $PARAM=$DEFAULT, ...):
              ...
    paths:
      include:
        - src/
      exclude:
        - tests/

  - id: xrag.no-dict-get-with-default
    languages: [python]
    message: >
      Using .get() with a default value hides missing configuration. Access the key
      directly or use explicit validation instead or raise an error when the value is expected but missing.
    severity: ERROR
    pattern: $DICT.get($KEY, $DEFAULT)
    paths:
      include:
        - src/
      exclude:
        - tests/

  - id: xrag.no-pydantic-field-default
    languages: [python]
    message: >
      Default values in Pydantic Field() hide configuration errors. Use Field(...)
      without default= to keep fields required, or use explicit optional types with
      None if the field is truly optional.
    severity: ERROR
    pattern: $FIELD = Field(..., default=..., ...)
    paths:
      include:
        - src/
      exclude:
        - tests/
```

---

### config/semgrep/no-sneaky-fallbacks.yml

Prevents silent fallback patterns that hide missing configuration:

```yaml
rules:
  - id: xrag.no-conditional-expression-fallback
    languages: [python]
    message: >
      Conditional expression with fallback value hides missing data.
      Use explicit validation and raise an error when the value is expected but missing,
      or use Optional types if the value is truly optional.
    severity: ERROR
    pattern: $VAR = $DICT[$KEY] if $KEY in $DICT else $DEFAULT
    paths:
      include:
        - src/
      exclude:
        - tests/

  - id: xrag.no-or-operator-fallback
    languages: [python]
    message: >
      OR operator fallback hides None/empty values. Use explicit None checks
      and raise an error when the value is expected but missing.

      Example violations:
        # WRONG - hides missing config with hardcoded default
        endpoint = otlp_endpoint or os.getenv(
            "OTEL_EXPORTER_OTLP_ENDPOINT",
            "http://tempo.monitoring.svc.cluster.local:4317",
        )

        # STILL WRONG - removes hardcoded default, but 'or' still hides None
        endpoint = otlp_endpoint or os.getenv("OTEL_EXPORTER_OTLP_ENDPOINT")

        # CORRECT - require explicit value, no fallbacks
        endpoint = otlp_endpoint
        if endpoint is None:
            raise ValueError("otlp_endpoint is required")
    severity: ERROR
    pattern: $VAR = $EXPR or $DEFAULT
    paths:
      include:
        - src/
      exclude:
        - tests/

  - id: xrag.no-getattr-with-default
    languages: [python]
    message: >
      getattr() with default value hides missing attributes.
      Access attributes directly or use hasattr() with explicit error handling.
    severity: ERROR
    pattern: getattr($OBJ, $ATTR, $DEFAULT)
    paths:
      include:
        - src/
      exclude:
        - tests/

  - id: xrag.no-ternary-none-check-fallback
    languages: [python]
    message: >
      Ternary expression with fallback for None check hides missing configuration.
      Use explicit validation and raise an error when None is unexpected.
    severity: WARNING
    pattern: $VAR = $DEFAULT if $EXPR is None else $EXPR
    paths:
      include:
        - src/
      exclude:
        - tests/

  - id: xrag.no-walrus-or-fallback
    languages: [python]
    message: >
      Walrus operator with fallback hides missing values.
      Use explicit validation instead.
    severity: ERROR
    pattern: ($VAR := $EXPR) or $DEFAULT
    paths:
      include:
        - src/
      exclude:
        - tests/
```

---

### config/semgrep/no_type_suppression.yml

Bans all forms of type error suppression:

```yaml
rules:
  - id: python.no-type-ignore
    languages: [python]
    severity: ERROR
    message: |
      Type-suppression is not allowed.
      Do NOT add or keep: '# type: ignore' (including '[code]').
      Fix the underlying typing issue instead: adjust annotations/signatures, add guards for Optional/Union,
      correct generics/collections types, or refactor into typed helpers. If you believe suppression is required,
      do not patch—explain why and propose a refactor that avoids suppression.
    pattern-regex: '(?m)#\s*type:\s*ignore(\[[^\]]*\])?'
    paths:
      include:
        - src/
      exclude:
        - tests/

  - id: python.no-mypy-ignore-errors
    languages: [python]
    severity: ERROR
    message: |
      File-level type suppression is not allowed.
      Do NOT add or keep: '# mypy: ignore-errors'.
      Fix typing properly (signatures, guards, generics, helpers). If you cannot fix without suppression,
      do not patch—explain the blocker and a suppression-free refactor plan.
    pattern-regex: '(?m)^\s*#\s*mypy:\s*ignore-errors\b'
    paths:
      include:
        - src/
      exclude:
        - tests/

  - id: python.no-mypy-disable-error-code
    languages: [python]
    severity: ERROR
    message: |
      Disabling mypy error codes inline is not allowed.
      Do NOT add or keep: '# mypy: disable-error-code=...'.
      Fix the typing source (types, narrowing, generics, helpers). If unavoidable, do not patch—explain why
      and propose a refactor that avoids suppression.
    pattern-regex: '(?m)^\s*#\s*mypy:\s*disable-error-code\s*='
    paths:
      include:
        - src/
      exclude:
        - tests/

  - id: python.no-pyright-ignore
    languages: [python]
    severity: ERROR
    message: |
      Pyright suppression is not allowed.
      Do NOT add or keep: '# pyright: ignore'.
      Fix the underlying typing issue instead (types, narrowing, refactor). If you cannot fix without suppression,
      do not patch—explain the blocker and a suppression-free refactor plan.
    pattern-regex: '(?m)(^\s*#\s*pyright:\s*ignore\b|#\s*pyright:\s*ignore\b)'
    paths:
      include:
        - src/
      exclude:
        - tests/
```

---

### config/semgrep/no-noqa.yml

Bans `# noqa` comments to force actual fixes:

```yaml
rules:
  - id: python.no-noqa-for-typing
    languages: [python]
    severity: ERROR
    message: |
      Do not use '# noqa' to silence typing-related issues.
      Fix the typing issue instead; if you cannot, explain why and propose a suppression-free refactor plan.
    pattern-regex: '(?m)#\s*noqa(?::\s*.*)?'
    paths:
      include:
        - src/
      exclude:
        - tests/
```

---

### config/semgrep/python-constants.yml

Prohibits module-level primitive constants:

```yaml
rules:
  # Prohibit module-level primitive constant declarations
  - id: xrag.no-module-level-constants
    languages: [python]
    message: >
      Module-level primitive constants are prohibited.
      Put them inside 'if __name__ == "__main__":' blocks for scripts and use config files and config classes for any production purpose.
    severity: ERROR
    patterns:
      # Match module-level assignments
      - pattern: $CONST = $VALUE
      # Exclude assignments inside class definitions
      - pattern-not-inside: |
          class $CLASS:
              ...
      # Exclude assignments inside if __name__ == '__main__' blocks
      - pattern-not-inside: |
          if __name__ == "__main__":
              ...
      - pattern-not-inside: |
          if __name__ == '__main__':
              ...
      # Exclude type annotations (these are not assignments)
      - pattern-not: |
          $VAR: $TYPE = ...
      # Exclude function/method definitions
      - pattern-not-inside: |
          def $FUNC(...):
              ...
      # Exclude common module-level non-constant variables
      - metavariable-pattern:
          metavariable: $CONST
          patterns:
            - pattern-not-regex: '^(logger|_.*|__.*__)$'
      # Exclude type aliases (Literal, Union, Optional, etc.)
      - pattern-not: $VAR = Literal[...]
      - pattern-not: $VAR = Union[...]
      - pattern-not: $VAR = Optional[...]
      # Exclude TypeVar and ParamSpec
      - pattern-not: $VAR = TypeVar(...)
      - pattern-not: $VAR = ParamSpec(...)
      # Exclude Prometheus metrics
      - pattern-not: $VAR = Counter(...)
      - pattern-not: $VAR = Gauge(...)
      - pattern-not: $VAR = Histogram(...)
      - pattern-not: $VAR = Summary(...)
      # Exclude application/framework instances
      - pattern-not: $VAR = FastAPI(...)
      - pattern-not: $VAR = Flask(...)
      - pattern-not: $VAR = APIRouter(...)
      - pattern-not: $VAR = Jinja2Templates(...)
      # Exclude Path operations (including chained attribute/division operations)
      - pattern-not: $VAR = ... / "$STR"
      - pattern-not: $VAR = ... / $STR
      - pattern-not: $VAR = Path(...)
      - pattern-not: $VAR = $OBJ.parent
      # Exclude template strings (usually UPPER_CASE and multiline)
      - metavariable-pattern:
          metavariable: $CONST
          patterns:
            - pattern-not-regex: '.*_TEMPLATE$'
      # Exclude class/type aliases (direct assignment of a class/type name)
      - metavariable-pattern:
          metavariable: $VALUE
          patterns:
            - pattern-not-regex: '^[A-Z][a-zA-Z0-9]*$'
      # Only match primitive literal values (not function calls, objects, etc.)
      - metavariable-pattern:
          metavariable: $VALUE
          patterns:
            - pattern-either:
                - pattern: $INT
                - pattern: $FLOAT
                - pattern: "$STR"
                - pattern: "True"
                - pattern: "False"
            # Exclude function calls, method calls, and complex expressions
            - pattern-not: $FUNC(...)
            - pattern-not: $OBJ.$METHOD
            - pattern-not: $OBJ.$ATTR
            - pattern-not: $OBJ[...]
      # Exclude standard module metadata
      - metavariable-regex:
          metavariable: $CONST
          regex: '^(?!(__all__|__version__|__author__|__email__|__license__|__name__|__file__|__doc__|T|K|V|TypeVar)).*'
    paths:
      include:
        - "**/src/**/*.py"
      exclude:
        # Allow constants in test files
        - "**/tests/**"
        # Allow in generated code
        - "**/src/proto_gen/**"
```

---

### config/codespell/ignore.txt

Domain-specific terms to ignore during spell checking:

```
# Domain-specific terms that codespell should ignore
# One word per line, case-insensitive
# Add new terms as false positives are discovered

# Infrastructure & Tools
grpc
grpcio
weaviate
minio
uvicorn
haystack
prometheus
grafana
kubectl
kubernetes
redis
kafka
aiokafka

# Python & Libraries
pydantic
pytest
mypy
ruff
fastapi
openai
httpx
hiredis

# Project-specific
xrag
proto
protobuf
servicer

# Technical terms
uuid
uuids
```

---

## Validation Tools Reference

| Make Target | Tool | What It Validates | When to Run |
|-------------|------|-------------------|-------------|
| `code-style` | ruff | Code style and formatting (read-only check) | Before committing |
| `code-format` | ruff | Auto-fix code style and formatting | Before committing |
| `code-typecheck` | mypy | Static type checking (strict mode) | Before committing |
| `code-lspchecks` | pyright | LSP-based type checking (strict mode) | In CI |
| `code-security` | bandit | Security vulnerabilities in code | In CI |
| `code-deptry` | deptry | Dependency hygiene (unused, missing, transitive) | In CI |
| `code-stats` | pygount | Code statistics (lines, files) | On demand |
| `code-spell` | codespell | Spelling errors in code and docs | Before committing |
| `code-audit` | pip-audit | Known vulnerabilities in dependencies | Weekly/before releases |
| `code-semgrep` | semgrep | Custom static analysis rules | Before committing |
| `test` | pytest | Unit tests | Before committing |
| `test-coverage` | pytest-cov | Unit tests with 80% coverage requirement | In CI |
| `ci` | all | Run all checks (verbose) | Locally before push |
| `ci-quiet` | all | Run all checks (silent, fail-fast) | Pre-commit hook |

---

## Usage

1. **Copy configuration files** into your project:
   - Add Makefile targets to your Makefile
   - Add `[tool.*]` sections to your pyproject.toml
   - Copy pyrightconfig.json
   - Copy .pre-commit-config.yaml
   - Create `config/semgrep/` and `config/codespell/` directories with rule files

2. **Install dependencies**:
   ```bash
   # Add dev dependencies to pyproject.toml, then:
   uv sync --all-extras
   # or with pip:
   pip install -e ".[dev]"
   ```

3. **Initialize**:
   ```bash
   make init
   ```

4. **Run validation**:
   ```bash
   make ci              # Run all checks (verbose)
   make ci-quiet        # Run all checks (silent, fail-fast)
   ```

5. **Install pre-commit hook**:
   ```bash
   uv run pre-commit install
   ```

---

## Notes

- All validation tools run using `uv run` prefix (works with any Python package manager)
- Reports are generated in `reports/` directory (add to .gitignore)
- Semgrep rules enforce explicit configuration patterns (no default values, no type suppressions)
- Coverage threshold is set to 80% (adjust in pyproject.toml `[tool.coverage.report]`)
- Pyright requires `stubs/` directory for custom type stubs (create if needed)
